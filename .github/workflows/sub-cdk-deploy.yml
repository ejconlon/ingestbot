# Deploys to the given environment
name: sub-cdk-deploy
on:
  workflow_call:
    inputs:
      env:
        type: string
        required: true
      env_title:
        type: string
        required: true
jobs:
  # Deploy with CDK
  deploy:
    environment: ${{ inputs.env }}
    runs-on: ubuntu-latest
    container:
      image: python:3.9.13
    steps:
      # Need node + unzip + cdk
      - name: Install utils
        run: apt-get update && apt-get install -y nodejs npm unzip && npm install -g aws-cdk
      - name: Checkout
        uses: actions/checkout@v3
      - name: Create build dir
        run: mkdir -p .build
      - name: Download cdk artifact
        uses: actions/download-artifact@v3
        with:
          name: ibot_cdk.zip
          path: .build/ibot_cdk.zip
      - name: Download api artifact
        uses: actions/download-artifact@v3
        with:
          name: ibot_api.zip
          path: .build/ibot_api.zip
      - name: Extract cdk code
        run: pwd && ls -lash . && unzip ibot_cdk.zip -d ibot_cdk
        working-directory: .build
      - name: Deploy api
        run: source ../../scripts/source_deploy.sh && ibot_assume_deploy_role ${{ inputs.env }} ci && ./entrypoint.sh deploy -e Ibot${{ inputs.env_title }}ApiStack
        working-directory: .build/ibot_cdk
